version: v1.0
name: Staging 1
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Deploy
    task:
      secrets:
        - name: infra-repository-ssh-keys
        - name: sentry-secrets
      jobs:
        - name: "Deploy"
          commands:
            - chmod 0600 /home/semaphore/.ssh/infra_deploy_key
            - ssh-add /home/semaphore/.ssh/infra_deploy_key
            - checkout
            - export DOCKER_TAG=$(git rev-parse --short HEAD)
            - cd /tmp
            - git clone git@github.com:/operately/infra
            - cd infra
            - "make update.app.image TAG=${DOCKER_TAG} > /dev/null"
            - "make stg1.app.deploy > /tmp/deploy.txt"
            - artifact push job /tmp/deploy.txt
            - git config --global user.email "hello@operately.com"
            - git config --global user.name "Semaphore"
            - git add .
            - git commit -m "Release new app image operately/operately:${DOCKER_TAG} to staging"
            - git push

        - name: "Upload JS Maps to sentry"
          commands:
            - mkdir -p tmp
            - artifact pull workflow app.js.map --destination tmp/app.js.map
            - curl -sL https://sentry.io/get-cli/ | sh
            - export SENTRY_ORG=operately
            - export SENTRY_PROJECT=operately-staging-1
            - sentry-cli sourcemaps inject tmp/
            - sentry-cli sourcemaps upload tmp/
